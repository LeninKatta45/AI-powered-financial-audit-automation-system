<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ company_name }} | Enviscale Financial Health Report</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @page {
            size: A4;
            margin: 0;
            @bottom-center {
                content: "Confidential - " counter(page) " of " counter(pages);
                font-family: 'Inter', sans-serif;
                font-size: 8pt;
                color: #6b7280;
            }
        }

        /* Cover Page */
        .cover-page {
            height: 297mm;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 30mm;
            background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%);
        }

        .cover-logo {
            text-align: center;
            margin-bottom: 20mm;
        }

        .cover-main {
            text-align: center;
        }

        .cover-title {
            font-size: 28pt;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8mm;
        }

        .cover-subtitle {
            font-size: 16pt;
            color: #4f46e5;
            font-weight: 500;
            margin-bottom: 15mm;
        }

        .cover-company {
            font-size: 22pt;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15mm;
        }

        .cover-meta {
            font-size: 10pt;
            color: #6b7280;
            margin-top: auto;
        }

        .cover-watermark {
            position: absolute;
            opacity: 0.03;
            font-size: 120pt;
            font-weight: 700;
            color: #4f46e5;
            transform: rotate(-30deg);
            z-index: -1;
            left: 20mm;
            top: 80mm;
        }

        /* Main Content */
        body {
            font-family: 'Inter', sans-serif;
            color: #1f2937;
            font-size: 10pt;
            line-height: 1.6;
            padding: 15mm;
            counter-reset: page 1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #4f46e5;
            padding-bottom: 12pt;
            margin-bottom: 8mm;
        }

        .header-title {
            flex: 1;
        }

        .header-title h1 {
            color: #111827;
            font-size: 18pt;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }

        .header-title .subtitle {
            color: #6b7280;
            font-size: 9pt;
            margin-top: 2pt;
        }

        .header-details {
            text-align: right;
            font-size: 8pt;
            color: #4b5563;
        }

        .header-details strong {
            display: block;
            font-size: 10pt;
            color: #111827;
            margin-bottom: 2pt;
        }

        /* Summary Section */
        .summary-section {
            margin: 8mm 0;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8pt;
            padding: 6mm;
            page-break-inside: avoid;
        }

        .section-title {
            font-size: 14pt;
            color: #111827;
            margin: 6mm 0 4mm 0;
            padding-bottom: 3pt;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
        }

        .subsection-title {
            font-size: 12pt;
            color: #4f46e5;
            margin: 5mm 0 3mm 0;
            font-weight: 600;
        }

        .summary-block {
            margin: 4mm 0;
        }

        .summary-block h3 {
            font-size: 10pt;
            font-weight: 600;
            color: #111827;
            margin-bottom: 2pt;
            display: flex;
            align-items: center;
        }

        .summary-block h3 .icon {
            margin-right: 4pt;
            font-size: 12pt;
        }

        .summary-block p {
            font-size: 9pt;
            color: #374151;
            margin: 0;
            text-align: justify;
        }

        /* KPI Dashboard */
        .kpi-dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4mm;
            margin: 6mm 0 8mm 0;
            page-break-inside: avoid;
        }

        .kpi-box {
            background: white;
            border-radius: 6pt;
            padding: 5mm;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-top: 4px solid;
            position: relative;
            overflow: hidden;
        }

        .kpi-box::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 20px 20px 0;
            border-color: transparent rgba(0,0,0,0.05) transparent transparent;
        }

        .kpi-box.critical { border-color: #dc2626; }
        .kpi-box.high { border-color: #f97316; }
        .kpi-box.medium { border-color: #f59e0b; }
        .kpi-box.low { border-color: #4f46e5; }
        .kpi-box.opportunity { border-color: #16a34a; }

        .kpi-title {
            font-size: 8pt;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 2mm;
            display: flex;
            justify-content: space-between;
        }

        .kpi-value {
            font-size: 16pt;
            font-weight: 700;
            margin-bottom: 1mm;
            color: #111827;
        }

        .kpi-value small {
            font-size: 10pt;
            font-weight: 500;
            opacity: 0.8;
        }

        .kpi-trend {
            font-size: 8pt;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .kpi-trend.up { color: #16a34a; }
        .kpi-trend.down { color: #dc2626; }
        .kpi-trend.neutral { color: #6b7280; }

        .kpi-sparkline {
            height: 20px;
            margin-top: 2mm;
            background: #f3f4f6;
            border-radius: 3pt;
            overflow: hidden;
        }

        .kpi-sparkline-line {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #8b5cf6);
            width: 70%;
        }

        /* Risk Matrix */
        .risk-matrix {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2mm;
            margin: 5mm 0;
        }

        .risk-item {
            height: 20mm;
            border-radius: 4pt;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 600;
            font-size: 8pt;
            text-align: center;
            padding: 2mm;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .risk-item.severity-1 { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .risk-item.severity-2 { background-color: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
        .risk-item.severity-3 { background-color: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        .risk-item.severity-4 { background-color: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }

        .risk-item .risk-value {
            font-size: 12pt;
            font-weight: 700;
            margin-bottom: 1mm;
        }

        /* Findings Tables */
        .findings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8pt;
            page-break-inside: avoid;
            margin: 4mm 0 8mm 0;
        }

        .findings-table th, 
        .findings-table td {
            padding: 3mm 2mm;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            page-break-inside: avoid;
        }

        .findings-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #374151;
            font-size: 8pt;
            text-transform: uppercase;
            letter-spacing: 0.5pt;
        }

        .findings-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .risk-tag {
            display: inline-block;
            padding: 1mm 2mm;
            border-radius: 4pt;
            font-size: 7pt;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5pt;
        }

        .risk-tag.critical { background-color: #fee2e2; color: #b91c1c; }
        .risk-tag.high { background-color: #ffedd5; color: #9a3412; }
        .risk-tag.medium { background-color: #fef3c7; color: #92400e; }
        .risk-tag.low { background-color: #dbeafe; color: #1e40af; }
        .risk-tag.opportunity { background-color: #dcfce7; color: #166534; }

        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1mm 2mm;
            border-radius: 4pt;
            font-size: 7pt;
            font-weight: 600;
            min-width: 16pt;
        }

        .status-badge.repeat {
            background-color: #ffedd5;
            color: #9a3412;
        }

        .status-badge.new {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-badge.urgent::after {
            content: "!";
            color: #dc2626;
            margin-left: 1mm;
            font-weight: 700;
        }

        /* Vendor Analysis */
        .vendor-analysis {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5mm;
            margin: 5mm 0;
        }

        .vendor-concentration {
            background-color: #f8fafc;
            padding: 4mm;
            border-radius: 6pt;
            border-left: 3px solid #4f46e5;
        }

        .vendor-list {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 6pt;
            overflow: hidden;
        }

        .vendor-list-header {
            background-color: #f3f4f6;
            padding: 3mm;
            font-weight: 600;
            font-size: 9pt;
            border-bottom: 1px solid #e5e7eb;
        }

        .vendor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3mm;
            border-bottom: 1px solid #f3f4f6;
            font-size: 8pt;
        }

        .vendor-item:last-child {
            border-bottom: none;
        }

        .vendor-name {
            font-weight: 500;
        }

        .vendor-spend {
            font-weight: 600;
            color: #4f46e5;
        }

        /* Charts */
        .chart-container {
            height: 40mm;
            margin: 5mm 0;
            background-color: #f9fafb;
            border-radius: 6pt;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 9pt;
            page-break-inside: avoid;
        }

        .chart-placeholder {
            text-align: center;
            padding: 5mm;
        }

        /* Recommendations */
        .recommendations {
            margin: 8mm 0;
        }

        .recommendation-card {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 6pt;
            padding: 4mm;
            margin-bottom: 3mm;
            page-break-inside: avoid;
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2mm;
        }

        .recommendation-title {
            font-weight: 600;
            color: #111827;
            font-size: 9pt;
        }

        .recommendation-priority {
            font-size: 7pt;
            font-weight: 600;
            padding: 1mm 2mm;
            border-radius: 4pt;
        }

        .priority-high { background-color: #fee2e2; color: #b91c1c; }
        .priority-medium { background-color: #fef3c7; color: #92400e; }
        .priority-low { background-color: #ecfdf5; color: #059669; }

        .recommendation-meta {
            display: flex;
            gap: 3mm;
            font-size: 7pt;
            color: #6b7280;
            margin-bottom: 2mm;
        }

        .recommendation-impact {
            display: inline-flex;
            align-items: center;
        }

        .recommendation-content {
            font-size: 8pt;
        }

        /* Appendix */
        .appendix {
            margin-top: 10mm;
            font-size: 8pt;
            color: #6b7280;
            border-top: 1px solid #e5e7eb;
            padding-top: 3mm;
        }

        /* Page breaks */
        .page-break {
            page-break-before: always;
        }

        /* Responsive */
        @media screen and (max-width: 768px) {
            .kpi-dashboard {
                grid-template-columns: 1fr 1fr;
            }
            
            .vendor-analysis {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- Cover Page -->
    <div class="cover-page">
        <div class="cover-logo">
            <div style="font-size: 24pt; font-weight: 700; color: #4f46e5;">Enviscale</div>
            <div style="font-size: 10pt; color: #6b7280; margin-top: 2mm;">Financial Health Diagnostics</div>
        </div>
        
        <div class="cover-main">
            <div class="cover-title">Financial Health Report</div>
            <div class="cover-subtitle">Comprehensive Risk & Opportunity Analysis</div>
            <div class="cover-company">{{ company_name }}</div>
        </div>
        
        <div class="cover-meta">
            <div>Report Period: {{ audit_period }}</div>
            <div>Generated: {{ report_date }}</div>
            <div style="margin-top: 5mm;">Confidential - For Executive Use Only</div>
        </div>
        
        <div class="cover-watermark">ENVISCALE</div>
    </div>

    <!-- Table of Contents -->
    <div class="page-break"></div>
    <div class="header">
        <div class="header-title">
            <h1>Table of Contents</h1>
        </div>
        <div class="header-details">
            <strong>{{ company_name }}</strong><br>
            {{ report_date }}
        </div>
    </div>

    <div style="margin-top: 10mm;">
        <div style="display: flex; justify-content: space-between; padding: 2mm 0; border-bottom: 1px solid #e5e7eb;">
            <span>Executive Summary</span>
            <span>3</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 2mm 0; border-bottom: 1px solid #e5e7eb;">
            <span>Financial Health Dashboard</span>
            <span>4</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 2mm 0; border-bottom: 1px solid #e5e7eb;">
            <span>Vendor Risk Analysis</span>
            <span>5</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 2mm 0; border-bottom: 1px solid #e5e7eb;">
            <span>Compliance Findings</span>
            <span>6-8</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 2mm 0; border-bottom: 1px solid #e5e7eb;">
            <span>Strategic Recommendations</span>
            <span>9-10</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 2mm 0; border-bottom: 1px solid #e5e7eb;">
            <span>Appendix & Methodology</span>
            <span>11</span>
        </div>
    </div>

    <!-- Executive Summary -->
    <div class="page-break"></div>
    <div class="header">
        <div class="header-title">
            <h1>Executive Summary</h1>
            <div class="subtitle">Key insights at a glance</div>
        </div>
        <div class="header-details">
            <strong>{{ company_name }}</strong><br>
            {{ report_date }}
        </div>
    </div>

    <div class="summary-section">
        <div class="summary-block">
            <h3><span class="icon">📊</span> Financial Overview</h3>
            <p>This report analyzes 
                {% if vendor_exposure.total_invoices %}{{ vendor_exposure.total_invoices }}{% else %}N/A{% endif %} 
                transactions totaling 
                {% if vendor_exposure.total_spend %}₹{{ "{:,.2f}".format(vendor_exposure.total_spend) }}{% else %}₹0.00{% endif %} 
                across 
                {% if vendor_exposure.vendor_count %}{{ vendor_exposure.vendor_count }}{% else %}N/A{% endif %} 
                vendors. The analysis identifies 
                {{ (vendor_findings|length + gst_findings|length + tds_findings|length) }} 
                compliance findings with a total risk exposure of 
                {% if total_risk_exposure %}₹{{ "{:,.2f}".format(total_risk_exposure) }}{% else %}₹0.00{% endif %}.
                </p>            
        </div>

        <div class="summary-block">
            <h3><span class="icon">⚠️</span> Top Risks</h3>
            <p>{{ vendor_summary }}</p>
        </div>

        <div class="summary-block">
            <h3><span class="icon">💡</span> Key Opportunities</h3>
            <p>{{ gst_summary }}</p>
        </div>
    </div>

    <!-- Financial Health Dashboard -->
    <div class="section-title">Financial Health Dashboard</div>

    <div class="kpi-dashboard">
        <div class="kpi-box opportunity">
            <div class="kpi-title">ITC Utilization <span>▲ 12%</span></div>
            <div class="kpi-value">87% <small>efficiency</small></div>
            <div class="kpi-trend up">5% improvement QoQ</div>
            <div class="kpi-sparkline">
                <div class="kpi-sparkline-line"></div>
            </div>
        </div>

        <div class="kpi-box medium">
            <div class="kpi-title">Invoice Quality <span>▼ 3%</span></div>
            <div class="kpi-value">{{ iqs_score.score }}% <small>({{ iqs_score.grade }})</small></div>
            <div class="kpi-trend down">{{ iqs_score.po_linked }}/{{ iqs_score.total_invoices }} with PO</div>
        </div>

        <div class="kpi-box high">
            <div class="kpi-title">Vendor Concentration</div>
            <div class="kpi-value">{{ vendor_exposure.concentration_percentage }}%</div>
            <div class="kpi-trend neutral">Top 10 vendors</div>
        </div>

        <div class="kpi-box low">
            <div class="kpi-title">Payment Efficiency</div>
            <div class="kpi-value">{{ payment_patterns.avg_payment_days }} <small>days</small></div>
            <div class="kpi-trend up">Improved from 45 days</div>
        </div>
    </div>

    <!-- Risk Matrix -->
    <div class="subsection-title">Risk Exposure Matrix</div>
    <div class="risk-matrix">
        <div class="risk-item severity-1">
            <div class="risk-value">₹{{ "{:,.0f}".format(risk_exposure.critical) }}</div>
            <div>Critical Risks</div>
        </div>
        <div class="risk-item severity-2">
            <div class="risk-value">₹{{ "{:,.0f}".format(risk_exposure.high) }}</div>
            <div>High Risks</div>
        </div>
        <div class="risk-item severity-3">
            <div class="risk-value">₹{{ "{:,.0f}".format(risk_exposure.medium) }}</div>
            <div>Medium Risks</div>
        </div>
       
        <div class="risk-item severity-4">
            <div class="risk-value">₹{{ "{:,.0f}".format(risk_exposure.opportunity) }}</div>
            <div>Recovery Opportunities</div>
        </div>
    </div>

    <!-- Vendor Risk Analysis -->
    <div class="page-break"></div>
    <div class="header">
        <div class="header-title">
            <h1>Vendor Risk Analysis</h1>
            <div class="subtitle">Spend patterns and concentration risks</div>
        </div>
        <div class="header-details">
            <strong>{{ company_name }}</strong><br>
            {{ report_date }}
        </div>
    </div>

    <div class="vendor-analysis">
        <div class="vendor-concentration">
            <div class="subsection-title">Vendor Concentration</div>
            <p>Your top 10 vendors account for <strong>{{ vendor_exposure.concentration_percentage }}%</strong> of total spend (₹{{ "{:,.2f}".format(vendor_exposure.total_spend) }}).</p>
            
            <div style="margin-top: 3mm;">
                <div style="display: flex; justify-content: space-between; font-size: 7pt; color: #6b7280; margin-bottom: 1mm;">
                    <span>Diversified</span>
                    <span>Concentrated</span>
                </div>
                <div style="height: 6pt; background: #e5e7eb; border-radius: 3pt; overflow: hidden;">
                    <div style="height: 100%; width: {{ vendor_exposure.concentration_percentage }}%; background: #4f46e5;"></div>
                </div>
            </div>
            
            <div style="font-size: 8pt; color: #6b7280; margin-top: 3mm;">
                <strong>Industry Benchmark:</strong> 35-60% for similar companies
            </div>
        </div>

        <div class="vendor-list">
            <div class="vendor-list-header">Top Vendors by Spend</div>
            {% for vendor in vendor_exposure.top_vendors %}
            <div class="vendor-item">
                <div class="vendor-name">{{ vendor.vendor|truncate(25) }}</div>
                <div class="vendor-spend">₹{{ "{:,.0f}".format(vendor.spend) }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Payment Patterns -->
    <div class="subsection-title" style="margin-top: 8mm;">Payment Pattern Analysis</div>

    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 3mm; margin: 3mm 0;">
        <div style="background: white; border-radius: 4pt; padding: 3mm; text-align: center; border: 1px solid #e5e7eb;">
            <div style="font-size: 8pt; color: #6b7280;">Avg Payment Days</div>
            <div style="font-size: 12pt; font-weight: 600; color: #111827;">{{ payment_patterns.avg_payment_days }}</div>
        </div>
        <div style="background: white; border-radius: 4pt; padding: 3mm; text-align: center; border: 1px solid #e5e7eb;">
            <div style="font-size: 8pt; color: #6b7280;">Weekend Payments</div>
            <div style="font-size: 12pt; font-weight: 600; color: #111827;">{{ payment_patterns.weekend_payments }}</div>
        </div>
        <div style="background: white; border-radius: 4pt; padding: 3mm; text-align: center; border: 1px solid #e5e7eb;">
            <div style="font-size: 8pt; color: #6b7280;">Late Payments</div>
            <div style="font-size: 12pt; font-weight: 600; color: #111827;">{{ payment_patterns.late_payments }}</div>
        </div>
        <div style="background: white; border-radius: 4pt; padding: 3mm; text-align: center; border: 1px solid #e5e7eb;">
            <div style="font-size: 8pt; color: #6b7280;">Bulk Payment Days</div>
            <div style="font-size: 12pt; font-weight: 600; color: #111827;">{{ payment_patterns.bulk_payment_days }}</div>
        </div>
    </div>

    <!-- Spend Trend Chart -->
    <div class="chart-container">
        <div class="chart-placeholder">
            <div style="font-size: 10pt; margin-bottom: 2mm;">Monthly Spend Trend</div>
            <div style="color: #9ca3af; font-size: 8pt;">[Visualization of spend trends would appear here]</div>
        </div>
    </div>

    <!-- Detailed Findings -->
    <div class="page-break"></div>
    <div class="header">
        <div class="header-title">
            <h1>Compliance Findings</h1>
            <div class="subtitle">Detailed risk analysis</div>
        </div>
        <div class="header-details">
            <strong>{{ company_name }}</strong><br>
            {{ report_date }}
        </div>
    </div>

    {% if vendor_findings %}
    <div class="subsection-title">Vendor & Payment Findings</div>
    <table class="findings-table">
        <thead>
            <tr>
                <th>Risk</th>
                <th>Vendor</th>
                <th>Invoice</th>
                <th>Amount</th>
                <th>Details</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for item in vendor_findings %}
            <tr>
                <td><span class="risk-tag {{ 'critical' if item.issue_type == 'DUPLICATE_INVOICE' else 'high' }}">{{ item.issue_type.replace('_', ' ') }}</span></td>
                <td>{{ item.vendor|truncate(20) }}</td>
                <td>{{ item.invoice_number|truncate(12) }}</td>
                <td>₹{{ "%.2f"|format(item.amount) }}</td>
                <td>{{ item.details|truncate(40) }}</td>
                <td>
                    <span class="status-badge {{ 'repeat' if item.is_repeat else 'new' }}{{ ' urgent' if item.past_occurrences > 3 else '' }}">
                        {% if item.is_repeat %}{{ item.past_occurrences + 1 }}X{% else %}New{% endif %}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if gst_findings %}
    <div class="subsection-title">GST Compliance Findings</div>
    <table class="findings-table">
        <thead>
            <tr>
                <th>Type</th>
                <th>Vendor</th>
                <th>Invoice</th>
                <th>Amount</th>
                <th>Details</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for item in gst_findings %}
            <tr>
                <td><span class="risk-tag {{ 'opportunity' if item.issue_type == 'UNCLAIMED_ITC' else 'high' }}">{{ item.issue_type.replace('_', ' ') }}</span></td>
                <td>{{ item.vendor|truncate(20) }}</td>
                <td>{{ item.invoice_number|truncate(12) }}</td>
                <td>₹{{ "%.2f"|format(item.amount) }}</td>
                <td>{{ item.details|truncate(40) }}</td>
                <td>
                    <span class="status-badge {{ 'repeat' if item.is_repeat else 'new' }}{{ ' urgent' if item.past_occurrences > 3 else '' }}">
                        {% if item.is_repeat %}{{ item.past_occurrences + 1 }}X{% else %}New{% endif %}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if tds_findings %}
    <div class="subsection-title">TDS Compliance Findings</div>
    <table class="findings-table">
        <thead>
            <tr>
                <th>Type</th>
                <th>Vendor</th>
                <th>Amount Paid</th>
                <th>Section</th>
                <th>TDS Due</th>
                <th>TDS Deducted</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for item in tds_findings %}
            <tr>
                <td><span class="risk-tag {{ 'critical' if item.issue_type == 'TDS_NOT_DEDUCTED' else 'high' }}">{{ item.issue_type.replace('_', ' ') }}</span></td>
                <td>{{ item.vendor|truncate(15) }}</td>
                <td>₹{{ "%.2f"|format(item.amount_paid) }}</td>
                <td>{{ item.section }}</td>
                <td>₹{{ "%.2f"|format(item.expected_tds) }}</td>
                <td>₹{{ "%.2f"|format(item.tds_deducted if item.tds_deducted is not none else 0) }}</td>
                <td>
                    <span class="status-badge {{ 'repeat' if item.is_repeat else 'new' }}{{ ' urgent' if item.past_occurrences > 3 else '' }}">
                        {% if item.is_repeat %}{{ item.past_occurrences + 1 }}X{% else %}New{% endif %}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <!-- Strategic Recommendations -->
    <div class="page-break"></div>
    <div class="header">
        <div class="header-title">
            <h1>Strategic Recommendations</h1>
            <div class="subtitle">Actionable insights for financial improvement</div>
        </div>
        <div class="header-details">
            <strong>{{ company_name }}</strong><br>
            {{ report_date }}
        </div>
    </div>

    <div class="recommendations">
        <div class="recommendation-card">
            <div class="recommendation-header">
                <div class="recommendation-title">Implement Automated PO Matching</div>
                <div class="recommendation-priority priority-high">High Priority</div>
            </div>
            <div class="recommendation-meta">
                <div class="recommendation-impact">Impact: ₹{{ "{:,.0f}".format(iqs_score.total_invoices * 0.15) }} potential savings</div>
                <div>Effort: Medium</div>
                <div>Timeline: 3-6 months</div>
            </div>
            <div class="recommendation-content">
                Based on the Invoice Quality Score of {{ iqs_score.score }}%, implementing automated purchase order matching would address {{ iqs_score.total_invoices - iqs_score.po_linked }} invoices currently without PO linkage. This would reduce unauthorized spend by approximately 15% based on industry benchmarks.
            </div>
        </div>

        <div class="recommendation-card">
            <div class="recommendation-header">
                <div class="recommendation-title">Diversify Top Vendor Relationships</div>
                <div class="recommendation-priority priority-medium">Medium Priority</div>
            </div>
            <div class="recommendation-meta">
                <div class="recommendation-impact">Impact: 5-8% cost reduction opportunity</div>
                <div>Effort: High</div>
                <div>Timeline: 6-12 months</div>
            </div>
            <div class="recommendation-content">
                Current vendor concentration of {{ vendor_exposure.concentration_percentage }}% exceeds the recommended threshold of 60%. Developing relationships with 2-3 alternative vendors for the top categories could improve negotiation leverage and reduce supply chain risk.
            </div>
        </div>

        {{ strategic_recommendations|safe }}
    </div>

    <!-- Appendix -->
    <div class="page-break"></div>
    <div class="header">
        <div class="header-title">
            <h1>Appendix</h1>
            <div class="subtitle">Methodology & Definitions</div>
        </div>
        <div class="header-details">
            <strong>{{ company_name }}</strong><br>
            {{ report_date }}
        </div>
    </div>

    <div class="appendix">
        <div class="subsection-title">Methodology</div>
        <p>This report analyzes financial data using Enviscale's proprietary risk detection algorithms with the following methodology:</p>
        
        <ul style="font-size: 8pt; margin-left: 5mm; padding-left: 3mm;">
            <li style="margin-bottom: 2mm;">Data sources: Purchase registers, TDS ledgers, GSTR-2B/3B filings</li>
            <li style="margin-bottom: 2mm;">Analysis period: {{ audit_period }}</li>
            <li style="margin-bottom: 2mm;">Risk scoring based on RBI compliance guidelines and ICAI audit standards</li>
            <li style="margin-bottom: 2mm;">Vendor concentration benchmarks from McKinsey procurement studies</li>
        </ul>

        <div class="subsection-title">Key Definitions</div>
        <table style="width: 100%; font-size: 8pt; border-collapse: collapse; margin-top: 3mm;">
            <tr>
                <td style="padding: 2mm; border-bottom: 1px solid #e5e7eb; font-weight: 500;">Invoice Quality Score (IQS)</td>
                <td style="padding: 2mm; border-bottom: 1px solid #e5e7eb;">Percentage of invoices properly linked to purchase orders</td>
            </tr>
            <tr>
                <td style="padding: 2mm; border-bottom: 1px solid #e5e7eb; font-weight: 500;">Vendor Concentration</td>
                <td style="padding: 2mm; border-bottom: 1px solid #e5e7eb;">Percentage of total spend accounted for by top 10 vendors</td>
            </tr>
            <tr>
                <td style="padding: 2mm; border-bottom: 1px solid #e5e7eb; font-weight: 500;">ITC Utilization</td>
                <td style="padding: 2mm; border-bottom: 1px solid #e5e7eb;">Ratio of input tax credit claimed vs. available</td>
            </tr>
        </table>

        <div style="margin-top: 8mm; font-size: 7pt; color: #6b7280; border-top: 1px solid #e5e7eb; padding-top: 3mm;">
            <p>This report was generated by Enviscale's AI-powered financial health platform on {{ report_date }}. The information contained herein is confidential and intended solely for the use of {{ company_name }} management.</p>
            <p style="margin-top: 2mm;">© {{ now.year }} Enviscale Technologies Pvt Ltd. All rights reserved.</p>
        </div>
    </div>
</body>
</html>