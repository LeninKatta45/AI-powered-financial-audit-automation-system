<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enviscale Diagnostic Report</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        @page {
            size: A4;
            margin: 1cm;
            @bottom-center {
                content: "Generated by Enviscale | Page " counter(page);
                font-family: 'Inter', sans-serif;
                font-size: 9px;
                color: #9ca3af;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            color: #1f2937;
            font-size: 11pt;
            line-height: 1.6;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 3px solid #4f46e5;
            padding-bottom: 16px;
        }

        .header-title h1 {
            color: #111827;
            font-size: 26pt;
            font-weight: 700;
            margin: 0;
            line-height: 1.1;
        }

        .header-title p {
            color: #6b7280;
            margin-top: 4px;
            font-size: 10pt;
        }

        .header-details {
            text-align: right;
            font-size: 9pt;
            color: #4b5563;
        }

        .summary-section {
            margin-top: 24px;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
        }

        .summary-section h2 {
            font-size: 16pt;
            color: #111827;
            margin-top: 0;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .summary-block {
            margin-top: 16px;
        }

        .summary-block h3 {
            font-size: 12pt;
            font-weight: 600;
            color: #4f46e5; /* Indigo */
            margin-bottom: 4px;
        }

        .summary-block p {
            font-size: 10pt;
            color: #374151;
            margin: 0;
        }

        /* Enhanced KPI Dashboard */
        .kpi-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .kpi-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .kpi-box.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .kpi-box.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .kpi-box.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .kpi-title {
            font-size: 10pt;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 24pt;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .kpi-subtitle {
            font-size: 9pt;
            opacity: 0.8;
        }

        .findings-section {
            margin-top: 32px;
            page-break-before: auto;
        }

        .findings-section h2 {
            font-size: 18pt;
            color: #111827;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }

        .findings-section h3 {
            font-size: 14pt;
            color: #4f46e5;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
            page-break-inside: auto;
            margin-bottom: 20px;
        }

        th, td {
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 8px;
            text-align: left;
            page-break-inside: avoid;
        }

        thead tr {
            page-break-inside: avoid;
        }

        th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        tbody tr:hover {
            background-color: #e5e7eb;
        }

        .risk-critical { color: #dc2626; font-weight: 600; }
        .risk-high { color: #f97316; }
        .risk-medium { color: #f59e0b; }
        .risk-opportunity { color: #16a34a; font-weight: 600; }

        /* Status badges */
        .repeat-badge {
            background-color: #ffc107;
            color: #333;
            padding: 3px 8px;
            font-size: 8pt;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .new-badge {
            background-color: #28a745;
            color: white;
            padding: 3px 8px;
            font-size: 8pt;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .resolved-badge {
            background-color: #6c757d;
            color: white;
            padding: 3px 8px;
            font-size: 8pt;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* Vendor risk analysis */
        .vendor-risk-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }

        .vendor-concentration {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4f46e5;
        }

        .vendor-list {
            background-color: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .vendor-list-header {
            background-color: #f3f4f6;
            padding: 15px;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
        }

        .vendor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f3f4f6;
        }

        .vendor-item:last-child {
            border-bottom: none;
        }

        .vendor-name {
            font-weight: 500;
            color: #111827;
        }

        .vendor-spend {
            color: #4f46e5;
            font-weight: 600;
        }

        /* Payment pattern analysis */
        .payment-patterns {
            margin: 30px 0;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .pattern-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .pattern-card h4 {
            color: #4f46e5;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .pattern-value {
            font-size: 18pt;
            font-weight: 600;
            color: #111827;
            margin-bottom: 5px;
        }

        .pattern-description {
            color: #6b7280;
            font-size: 9pt;
        }

        .page-break { page-break-before: always; }

        /* Responsive adjustments for smaller screens */
        @media screen and (max-width: 768px) {
            .kpi-dashboard {
                grid-template-columns: 1fr;
            }
            
            .vendor-risk-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <h1>Enviscale</h1>
            <p>Confidential Diagnostic Report</p>
        </div>
        <div class="header-details">
            <strong>{{ company_name }}</strong><br>
            Audit Period: {{ audit_period }}<br>
            Report Date: {{ report_date }}
        </div>
    </div>

    <div class="summary-section">
        <h2>Executive Summary</h2>
        <div class="summary-block">
            <h3>Vendor & Payment Risks</h3>
            <p>{{ vendor_summary }}</p>
        </div>
        <div class="summary-block">
            <h3>GST Compliance & ITC Reconciliation</h3>
            <p>{{ gst_summary }}</p>
        </div>
        <div class="summary-block">
            <h3>TDS Compliance Risks</h3>
            <p>{{ tds_summary }}</p>
        </div>
    </div>

    <!-- Enhanced KPI Dashboard -->
    <div class="kpi-dashboard">
        <!-- In templates/report_template.html -->
        <div class="kpi-box success">
            <div class="kpi-title">Invoice Quality Score (IQS)</div>
            <!-- Show the Grade next to the score -->
            <div class="kpi-value">{{ iqs_score.score }}% <span style="font-size: 18pt; opacity: 0.8;">({{ iqs_score.grade }})</span></div>
            <div class="kpi-subtitle">Based on {{ iqs_score.total_invoices }} invoices</div>
        </div>
        <div class="kpi-box warning">
            <div class="kpi-title">Top 10 Vendor Concentration</div>
            <div class="kpi-value">{{ vendor_exposure.concentration_percentage }}%</div>
            <div class="kpi-subtitle">of total spend</div>
        </div>
        <div class="kpi-box info">
            <div class="kpi-title">Total Spend Analyzed</div>
            <div class="kpi-value">₹{{ "{:,.0f}".format(vendor_exposure.total_spend) }}</div>
            <div class="kpi-subtitle">across all vendors</div>
        </div>
        <div class="kpi-box">
            <div class="kpi-title">Average Payment Days</div>
            <div class="kpi-value">{{ payment_patterns.avg_payment_days }}</div>
            <div class="kpi-subtitle">days to payment</div>
        </div>
    </div>

    <!-- Vendor Concentration Risk Analysis -->
    <div class="vendor-risk-container">
        <div class="vendor-concentration">
            <h3>Vendor Concentration Risk</h3>
            <p>Your top 10 vendors account for <strong>{{ vendor_exposure.concentration_percentage }}%</strong> of your total spend of <strong>₹{{ "{:,.2f}".format(vendor_exposure.total_spend) }}</strong>.</p>
            <p style="margin-top: 15px; font-size: 9pt; color: #6b7280;">
                High vendor concentration increases supply chain risk and reduces negotiation leverage. Consider diversifying your vendor base for critical services.
            </p>
        </div>
        <div class="vendor-list">
            <div class="vendor-list-header">Top 10 Vendors by Spend</div>
            {% for vendor in vendor_exposure.top_vendors %}
            <div class="vendor-item">
                <div class="vendor-name">{{ vendor.vendor }}</div>
                <div class="vendor-spend">₹{{ "{:,.0f}".format(vendor.spend) }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Payment Pattern Analysis -->
    <div class="payment-patterns">
        <h3>Payment Pattern Analysis</h3>
        <div class="pattern-grid">
            <div class="pattern-card">
                <h4>Average Payment Days</h4>
                <div class="pattern-value">{{ payment_patterns.avg_payment_days }}</div>
                <div class="pattern-description">Average days from invoice to payment</div>
            </div>
            <div class="pattern-card">
                <h4>Weekend Payments</h4>
                <div class="pattern-value">{{ payment_patterns.weekend_payments }}</div>
                <div class="pattern-description">Payments made on weekends</div>
            </div>
            <div class="pattern-card">
                <h4>Late Payments</h4>
                <div class="pattern-value">{{ payment_patterns.late_payments }}</div>
                <div class="pattern-description">Payments beyond 30 days</div>
            </div>
            <div class="pattern-card">
                <h4>Bulk Payment Days</h4>
                <div class="pattern-value">{{ payment_patterns.bulk_payment_days }}</div>
                <div class="pattern-description">Days with 10+ payments</div>
            </div>
        </div>
    </div>

    <div class="findings-section">
        <h2>Detailed Findings</h2>

        {% if vendor_findings %}
        <h3>Vendor & Payment Findings</h3>
        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Vendor</th>
                    <th>Invoice #</th>
                    <th>Amount (₹)</th>
                    <th>Details</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in vendor_findings %}
                <tr>
                    <td class="{{ 'risk-critical' if item.issue_type == 'DUPLICATE_INVOICE' else 'risk-high' }}">{{ item.issue_type.replace('_', ' ') }}</td>
                    <td>{{ item.vendor }}</td>
                    <td>{{ item.invoice_number }}</td>
                    <td>{{ "%.2f"|format(item.amount) }}</td>
                    <td>{{ item.details }}</td>
                    <td>
                        {% if item.get('is_repeat', False) %}
                        <span class="repeat-badge">Repeated Issue</span>
                        {% else %}
                        <span class="new-badge">New</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if gst_findings %}
        <h3>GST Compliance Findings</h3>
        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Vendor</th>
                    <th>Invoice #</th>
                    <th>Amount (₹)</th>
                    <th>Details</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in gst_findings %}
                <tr>
                    <td class="{{ 'risk-opportunity' if item.issue_type == 'UNCLAIMED_ITC' else 'risk-high' }}">{{ item.issue_type.replace('_', ' ') }}</td>
                    <td>{{ item.vendor }}</td>
                    <td>{{ item.invoice_number }}</td>
                    <td>{{ "%.2f"|format(item.amount) }}</td>
                    <td>{{ item.details }}</td>
                    <td>
                        {% if item.get('is_repeat', False) %}
                        <span class="repeat-badge">Repeated Issue</span>
                        {% else %}
                        <span class="new-badge">New</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if tds_findings %}
        <h3>TDS Compliance Findings</h3>
        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Vendor</th>
                    <th>Amount Paid (₹)</th>
                    <th>Section</th>
                    <th>TDS Expected (₹)</th>
                    <th>TDS Deducted (₹)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in tds_findings %}
                <tr>
                    <td class="{{ 'risk-critical' if item.issue_type == 'TDS_NOT_DEDUCTED' else 'risk-high' }}">{{ item.issue_type.replace('_', ' ') }}</td>
                    <td>{{ item.vendor }}</td>
                    <td>{{ "%.2f"|format(item.amount_paid) }}</td>
                    <td>{{ item.section }}</td>
                    <td>{{ "%.2f"|format(item.expected_tds) }}</td>
                    <td>{{ "%.2f"|format(item.tds_deducted if item.tds_deducted is not none else 0) }}</td>
                    <td>
                        {% if item.get('is_repeat', False) %}
                        <span class="repeat-badge">Repeated Issue</span>
                        {% else %}
                        <span class="new-badge">New</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if anomalies %}
        <h3>Payment Anomalies</h3>
        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Vendor</th>
                    <th>Invoice #</th>
                    <th>Amount (₹)</th>
                    <th>Details</th>
                    <th>Risk Level</th>
                </tr>
            </thead>
            <tbody>
                {% for anomaly in anomalies %}
                <tr>
                    <td class="risk-medium">{{ anomaly.anomaly_type.replace('_', ' ') }}</td>
                    <td>{{ anomaly.vendor }}</td>
                    <td>{{ anomaly.invoice_number }}</td>
                    <td>{{ "%.2f"|format(anomaly.amount) }}</td>
                    <td>{{ anomaly.details }}</td>
                    <td class="risk-{{ anomaly.risk_level.lower() }}">{{ anomaly.risk_level }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>

    <!-- Strategic Recommendations -->
    <div class="findings-section">
        <h2>Strategic Recommendations</h2>
        <div class="summary-section">
            <div class="summary-block">
                <h3>Process Improvements</h3>
                <p>Implement automated invoice validation to reduce duplicate payments and improve processing efficiency. Consider setting up approval workflows for high-value transactions.</p>
            </div>
            <div class="summary-block">
                <h3>Vendor Management</h3>
                <p>Diversify vendor base to reduce concentration risk. Establish vendor performance metrics and regular reviews to ensure optimal supplier relationships.</p>
            </div>
            <div class="summary-block">
                <h3>Compliance Enhancement</h3>
                <p>Strengthen GST and TDS compliance processes through automated calculations and regular reconciliation. Implement preventive controls to avoid repeated compliance issues.</p>
            </div>
        </div>
    </div>
</body>
</html>